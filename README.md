# :ear_of_rice: GERSTE

***GER**man-**S**ecure-**T**imesync-**E**xecution*

<img src="https://i.ibb.co/DbXkYy3/barley-field-8230-960-720.jpg" width="300" height="200">

[![Arch](https://img.shields.io/badge/Arch%20Linux-1793D1?logo=arch-linux&logoColor=fff&style=for-the-badge)](https://archlinux.org/)
[![made-with-bash](https://img.shields.io/badge/-Made%20with%20Bash-1f425f.svg?style=for-the-badge&logo=image%2Fpng%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw%2FeHBhY2tldCBiZWdpbj0i77u%2FIiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8%2BIDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTExIDc5LjE1ODMyNSwgMjAxNS8wOS8xMC0wMToxMDoyMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkE3MDg2QTAyQUZCMzExRTVBMkQxRDMzMkJDMUQ4RDk3IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkE3MDg2QTAzQUZCMzExRTVBMkQxRDMzMkJDMUQ4RDk3Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QTcwODZBMDBBRkIzMTFFNUEyRDFEMzMyQkMxRDhEOTciIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QTcwODZBMDFBRkIzMTFFNUEyRDFEMzMyQkMxRDhEOTciLz4gPC9yZGY6RGVzY3JpcHRpb24%2BIDwvcmRmOlJERj4gPC94OnhtcG1ldGE%2BIDw%2FeHBhY2tldCBlbmQ9InIiPz6lm45hAAADkklEQVR42qyVa0yTVxzGn7d9Wy03MS2ii8s%2BeokYNQSVhCzOjXZOFNF4jx%2BMRmPUMEUEqVG36jo2thizLSQSMd4N8ZoQ8RKjJtooaCpK6ZoCtRXKpRempbTv5ey83bhkAUphz8fznvP8znn%2B%2F3NeEEJgNBoRRSmz0ub%2FfuxEacBg%2FDmYtiCjgo5NG2mBXq%2BH5I1ogMRk9Zbd%2BQU2e1ML6VPLOyf5tvBQ8yT1lG10imxsABm7SLs898GTpyYynEzP60hO3trHDKvMigUwdeaceacqzp7nOI4n0SSIIjl36ao4Z356OV07fSQAk6xJ3XGg%2BLCr1d1OYlVHp4eUHPnerU79ZA%2F1kuv1JQMAg%2BE4O2P23EumF3VkvHprsZKMzKwbRUXFEyTvSIEmTVbrysp%2BWr8wfQHGK6WChVa3bKUmdWou%2BjpArdGkzZ41c1zG%2Fu5uGH4swzd561F%2BuhIT4%2BLnSuPsv9%2BJKIpjNr9dXYOyk7%2FBZrcjIT4eCnoKgedJP4BEqhG77E3NKP31FO7cfQA5K0dSYuLgz2TwCWJSOBzG6crzKK%2BohNfni%2Bx6OMUMMNe%2Fgf7ocbw0v0acKg6J8Ql0q%2BT%2FAXR5PNi5dz9c71upuQqCKFAD%2BYhrZLEAmpodaHO3Qy6TI3NhBpbrshGtOWKOSMYwYGQM8nJzoFJNxP2HjyIQho4PewK6hBktoDcUwtIln4PjOWzflQ%2Be5yl0yCCYgYikTclGlxadio%2BBQCSiW1UXoVGrKYwH4RgMrjU1HAB4vR6LzWYfFUCKxfS8Ftk5qxHoCUQAUkRJaSEokkV6Y%2F%2BJUOC4hn6A39NVXVBYeNP8piH6HeA4fPbpdBQV5KOx0QaL1YppX3Jgk0TwH2Vg6S3u%2BdB91%2B%2FpuNYPYFl5uP5V7ZqvsrX7jxqMXR6ff3gCQSTzFI0a1TX3wIs8ul%2Bq4HuWAAiM39vhOuR1O1fQ2gT%2F26Z8Z5vrl2OHi9OXZn995nLV9aFfS6UC9JeJPfuK0NBohWpCHMSAAsFe74WWP%2BvT25wtP9Bpob6uGqqyDnOtaeumjRu%2ByFu36VntK%2FPA5umTJeUtPWZSU9BCgud661odVp3DZtkc7AnYR33RRC708PrVi1larW7XwZIjLnd7R6SgSqWSNjU1B3F72pz5TZbXmX5vV81Yb7Lg7XT%2FUXriu8XLVqw6c6XqWnBKiiYU%2BMt3wWF7u7i91XlSEITwSAZ%2FCzAAHsJVbwXYFFEAAAAASUVORK5CYII%3D)](https://www.gnu.org/software/bash/) 
[![Badge License](https://img.shields.io/badge/License-GPL3-015d93.svg?style=for-the-badge&labelColor=blue)](https://github.com/paranoidpeter/gerste/blob/main/LICENSE)

This tiny bash script updates your system clock. It uses  `wget`  (optionally through  `torsocks` ) to obtain the header of a given domain without downloading the website, after that it `grep`s the timestamp and, based on whether it's summer- or wintertime, it automatically updates the systemtime correctly with `date`. By default, `gerste` sends traffic through clearnet (to use `tor` &rarr; see below: :rocket: [Usage](https://github.com/paranoidpeter/gerste#rocket-usage)).

This script may be useful for other countries¹ since not only Germany changes clocktime twice a year. Without keeping this in mind, the first impulse for a good name was `gerste` (maybe because of the association to beer?).

¹ all countries in the CET/CEST-Timezone. Otherwise change the timezone if needed (see below: :gear: [Configuration](https://github.com/paranoidpeter/gerste#gear-configuration)).

I got inspired by [secure-time-sync](https://github.com/Obscurix/Obscurix/blob/master/airootfs/usr/lib/obscurix/secure-time-sync) to write this script.

## :notebook_with_decorative_cover: Table of contents
- [Preparation](https://github.com/paranoidpeter/gerste#hammer_and_wrench-preparation)
- [Installation](https://github.com/paranoidpeter/gerste#cd-installation)
  - [Install to use in terminal](https://github.com/paranoidpeter/gerste#computer-install-to-use-in-terminal)
  - [Enabling automatic timesync on network connection (NetworkManager)](https://github.com/paranoidpeter/gerste#globe_with_meridians-enabling-automatic-timesync-on-network-connection-networkmanager)
  - [Enable automatic timesync every X minutes (systemd timer)](https://github.com/paranoidpeter/gerste#hourglass-enable-automatic-timesync-every-x-minutes-systemd-timer)
- [Configuration](https://github.com/paranoidpeter/gerste#gear-configuration)
- [Usage](https://github.com/paranoidpeter/gerste#rocket-usage)
- [Debugging](https://github.com/paranoidpeter/gerste#beetle-debugging)
- [Why?](https://github.com/paranoidpeter/gerste#interrobang-why)
- [Contact](https://github.com/paranoidpeter/gerste#envelope-contact)

## :hammer_and_wrench: Preparation

1. The executing user needs root access (or sudo/doas)
2. Make sure that `/etc/localtime` is set correctly

```bash
  > ln -sf /usr/share/zoneinfo/Europe/Berlin /etc/localtime
```

3. Install dependencies

```bash
  > pacman -S wget shuf date
```

4. **Optional:** Install and enable dependencies for using gerste through tor
```bash
  > pacman -S tor torsocks
  > systemctl enable tor.service
```

> [!NOTE]
> Systemd is used to verify whether tor.service is running. If running another init system you have to change the values in code below "# Check if tor.service is active"

## :cd: Installation

### :computer: Install to use in terminal

```bash
  > git clone https://github.com/paranoidpeter/gerste/
  > cd gerste
  > sudo chmod 755 install.sh
  > sudo ./install.sh
```
> [!NOTE]
> Make sure this step is done before enable automatic timesync options below.

### :globe_with_meridians: Enabling automatic timesync on network connection (NetworkManager)

> [!WARNING]
> Please read [NetworkManager-dispatcher(8)](https://man.archlinux.org/man/NetworkManager-dispatcher.8) and [Arch Linux - NetworkManager](https://wiki.archlinux.org/title/NetworkManager) before continuing. The following shows only the simple way which may lead to errors.

This dispatch script executes once after network is up.

**First:** If not already done first enable and start NetworkManager-dispatcher.service:
```bash
  > systemctl enable --now NetworkManager-dispatcher.service
```

#### Create a NetworkManager dispatch script

```bash
  > nano /etc/NetworkManager/dispatcher.d/01-gerste.sh
```

```bash
#!/bin/bash
case "$2" in
  up)
    /usr/local/bin/gerste
    ;;
esac
```

#### Enable the NetworkManager dispatch script

```bash
  > chown root:root /etc/NetworkManager/dispatcher.d/01-gerste.sh
  > systemctl restart NetworkManager
```

### :hourglass: Enable automatic timesync every X minutes (systemd timer)

> [!WARNING]
> Please read [systemd.timer(5)](https://man.archlinux.org/man/systemd.timer.5) and [Arch Linux - Systemd/Timers](https://wiki.archlinux.org/title/systemd/Timers) before continuing. The following shows only the simple way which may lead to errors.

#### Create gerste.timer (i.e. every 15min)

```bash
  > nano /usr/lib/systemd/system/gerste.timer
```

```bash
[Unit]
Description=Run gerste every 15min

[Timer]
OnCalendar=*:0,15,30,45
Persistent=true

[Install]
WantedBy=timers.target
```

#### Create gerste.service

```bash
  > nano /usr/lib/systemd/system/gerste.service
```

```bash
[Unit]
Description=Run gerste for automatic timesync
After=network-online.target

[Service]
Type=simple
ExecStart=/usr/local/bin/gerste
```

#### Enable gerste.timer

```bash
  > systemctl daemon-reload
  > systemctl enable --now gerste.timer
```

## :gear: Configuration

Open the script with your favourite text editor:

```bash
  > nano /usr/local/bin/gerste
```

You can:

1. Add or delete URLs which `wget` will trigger:<br/>
:exclamation: **IMPORTANT** :exclamation: Different web servers can give different datestamps, your systemtime **can** differ more than 10 seconds on every execution. By default only 1 URL is given to avoid such a behaviour.<br/>
1.1. Change the value of `server_urls=( example.onion )` or `server_urls=( example.org )` and make sure **at least one url** is configured. `server_urls` is a space separated list.<br/>

2. Use another timezone:<br />
2.1. Change the value in the first if-statement below `### WINTERTIME OPERATIONS` from `CET` to your preference. **It needs to be your winter-time-zone to keep functionality**.

## :rocket: Usage
After installation you can simply type:
```bash
  > gerste
```
> [!NOTE]
> Run without root privileges is possible. You will be prompted for sudo or doas password since changing systemtime is not supported for unprivileged users.

#### Command overview:

```
  > gerste [options]           Usage in terminal

  > gerste -t                  Use wget with torsocks to send 
  > gerste --tor               traffic through tor network.

  > gerste -v                  Get current version
  > gerste --version

  > gerste -d                  Enable debugging
  > gerste --debug
```

## :beetle: Debugging

##### Enable debugging with "-d" or "--debug" parameter

```bash
  > gerste -d
  > gerste --debug
```
If you need a more verbose debugging output you can add simple debug lines in script &rarr; `debug "text"`

## :interrobang: Why

I've started this script because of a random article which claims NTP as an insecure protocol.. don't remember where. I'm pretty much at the beginning of my linux journey and just wanted to do something. *Im open to improvements and tips.* However, since I'm affected by the "summer-winter-time-switching-model" the most public scripts like this won't work for me out of the box. So, I've decided to write my own script.<br>

## :envelope: Contact

**Mail:** peterparanoid@proton.me
